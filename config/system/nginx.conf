#########################################################
# Rosa: Home to LCBO API, LCBO Search, and various bits #
#########################################################
worker_processes 2;

user nginx;

pid /var/run/nginx.pid;
error_log /var/log/nginx/error.log;

events {
  worker_connections 1024;
  use epoll;
}

http {
  sendfile on;

  tcp_nopush on;
  tcp_nodelay off;

  client_max_body_size 5m;
  client_body_temp_path /var/spool/nginx-client-body 1 2;

  include /usr/local/nginx/conf/mime.types;
  default_type application/octet-stream;

  ###############
  # Compression #
  ###############
  gzip on;
  gzip_http_version 1.0;  # hmm, maybe this should be 1.1
  gzip_vary on;           # Set a vary header so downstream proxies don't send cached gzipped content to IE6
  gzip_comp_level 2;
  gzip_proxied any;
  gzip_min_length 1100;
  gzip_buffers 16 8k;     # see http://blog.leetsoft.com/2007/7/25/nginx-gzip-ssl
  gzip_disable "MSIE [1-6].(?!.*SV1)";
  gzip_types
    application/json
    application/vnd.google-earth.kml+xml
    application/kml+xml
    application/x-javascript
    application/xml
    application/atom+xml
    application/rss+xml
    text/css
    text/csv
    text/javascript
    text/json
    text/plain
    text/tsv
    text/xml
    text/xml+atom
    text/xml+rss;

  ###########
  # Logging #
  ###########
  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for" - $request_time';
  access_log /var/log/nginx/nginx.access.log main;
  error_log  /var/log/nginx/nginx.error.log notice;

  #############
  # Redirects #
  #############

  # Redirect stepmix.com => heycarsten.com
  server {
    server_name www.stepmix.com stepmix.com;
    rewrite ^(.*) http://heycarsten.com permanent;
  }

  # Redirect www.lcboapi.com => lcboapi.com
  server {
    server_name www.lcboapi.com;
    rewrite ^(.*) http://lcboapi.com$1 permanent;
  }

  # Redirect www.lcbosearch.com => lcbosearch.com
  server {
    server_name www.lcbosearch.com;
    rewrite ^(.*) http://lcbosearch.com$1 permanent;
  }

  ###############
  # lcboapi.com #
  ###############
  upstream lcboapi {
    server unix:/sites/lcboapi.com/shared/sockets/puma.sock fail_timeout=0;
  }

  server {
    server_name lcboapi.com pre.lcboapi.com;

    access_log /var/log/nginx/lcboapi.com.access.log main;
    error_log  /var/log/nginx/lcboapi.com.error.log notice;

    root /sites/lcboapi.com/current/public;

    location ~* \.(eot|ttf|woff)$ {
      add_header Access-Control-Allow-Origin *;
    }

    location ~ ^/(assets)/ {
      root /sites/lcboapi.com/current/public;
      expires max;
      add_header Cache-Control public;
      gzip_static on;
    }

    try_files $uri/index.html $uri.html $uri @app;

    location @app {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://lcboapi;
    }

    error_page 500 502 503 504 /500.html;
    location = /500.html {
      root /sites/lcboapi.com/current/public;
    }
  }

  ##################
  # lcbosearch.com #
  ##################
  upstream lcbosearch {
    server unix:/sites/lcbosearch.com/shared/sockets/puma.sock fail_timeout=0;
  }

  server {
    server_name lcbosearch.com pre.lcbosearch.com;

    access_log /var/log/nginx/lcbosearch.com.access.log main;
    error_log  /var/log/nginx/lcbosearch.com.error.log notice;

    root /sites/lcbosearch.com/current/public;

    location ^~ /lcboapi/ {
      proxy_pass http://lcboapi.com/;
    }

    location ~* \.(eot|ttf|woff)$ {
      add_header Access-Control-Allow-Origin *;
    }

    location ~ ^/(assets)/ {
      root /sites/lcbosearch.com/current/public;
      expires max;
      add_header Cache-Control public;
      gzip_static on;
    }

    try_files $uri/index.html $uri.html $uri @app;

    location @app {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://lcbosearch;
    }

    error_page 500 502 503 504 /500.html;
    location = /500.html {
      root /sites/lcbosearch.com/current/public;
    }
  }
}
